<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Radar BR — Pro</title>
</head>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    /* Esconde todas as colunas dinâmicas por padrão; o JS exibe as selecionadas */
    [data-col] { display: none; }
  </style>
<body>
<header class="app-header container">
  <div class="brand">
    <div class="logo">SR</div>
    <div class="titles">
      <h1>Stock Radar BR</h1>
      <p>Triagem dinâmica de ações da B3 com cálculo de valor intrínseco, sobre as 300 empresas com maior market cap</p>
    </div>
  </div>
</header>

<main class="container">
  <!-- Toolbar -->
  <form id="controls" method="get" class="toolbar card">
    <div class="toolbar-row">
      <div class="field">
        <label for="limit">Quantidade</label>
        <input id="limit" name="limit" type="number" min="1" max="100" th:value="${limit}">
      </div>

      <div class="field">
        <label for="method">Método de Avaliação</label>
        <select id="method" name="method" th:value="${method}">
          <option value="GRAHAM" th:selected="${method}=='GRAHAM'">Graham (padrão)</option>
          <option value="PE_TARGET" th:selected="${method}=='PE_TARGET'">P/E alvo</option>
          <option value="EV_EBITDA_TARGET" th:selected="${method}=='EV_EBITDA_TARGET'">EV/EBITDA alvo</option>
        </select>
      </div>

      <div class="field w-sm" id="peTargetWrap">
        <label for="peTarget">P/E alvo</label>
        <input id="peTarget" name="peTarget" type="number" step="0.1" min="1" max="40" placeholder="12" th:value="${peTarget}">
      </div>

      <div class="field w-sm" id="evTargetWrap">
        <label for="evTarget">EV/EBITDA alvo</label>
        <input id="evTarget" name="evTarget" type="number" step="0.1" min="1" max="20" placeholder="6" th:value="${evTarget}">
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit">Aplicar</button>
      </div>
    </div>

    <details class="cols details-reset">
      <summary class="cols-summary">
        <span class="icon">▦</span> Colunas visíveis
      </summary>
      <div class="cols-actions" style="display:flex; gap:8px; margin:10px 0 2px;">
        <button type="button" class="btn" id="btnAllColumns">Marcar todas</button>
        <button type="button" class="btn" id="btnDefaultColumns">Padrão</button>
      </div>
      <div class="cols-grid">
        <!-- marque/desmarque e seu JS já atualiza columnsField + data-col -->
        <label class="chip"><input type="checkbox" data-col="price" checked>Preço</label>
        <label class="chip"><input type="checkbox" data-col="eps" checked>EPS</label>
        <label class="chip"><input type="checkbox" data-col="bvps" checked>VPA</label>
        <label class="chip"><input type="checkbox" data-col="pe">P/L</label>
        <label class="chip"><input type="checkbox" data-col="pb">P/VP</label>
        <label class="chip"><input type="checkbox" data-col="marketCap">Market Cap</label>
        <label class="chip"><input type="checkbox" data-col="sharesOutstanding">Ações</label>
        <label class="chip"><input type="checkbox" data-col="totalDebt">Dívida</label>
        <label class="chip"><input type="checkbox" data-col="cash">Caixa</label>
        <label class="chip"><input type="checkbox" data-col="ebitda">EBITDA</label>
        <label class="chip"><input type="checkbox" data-col="equity">Patrimônio</label>
        <label class="chip"><input type="checkbox" data-col="netIncome">Lucro</label>
        <label class="chip"><input type="checkbox" data-col="revenue">Receita</label>
        <label class="chip"><input type="checkbox" data-col="ev">EV</label>
        <label class="chip"><input type="checkbox" data-col="evEbitda">EV/EBITDA</label>
        <label class="chip"><input type="checkbox" data-col="netMargin">Marg. Líq.%</label>
        <label class="chip"><input type="checkbox" data-col="roe">ROE%</label>
        <label class="chip"><input type="checkbox" data-col="intrinsic" checked>Valor Intrínseco</label>
        <label class="chip"><input type="checkbox" data-col="marginOfSafety" checked>MoS</label>
      </div>
      <input type="hidden" name="columns" id="columnsField" th:value="${selectedCols}"/>
    </details>
  </form>

  <!-- Grid -->
  <section class="card">
    <div class="table-wrap">
      <table class="table" id="grid">
        <thead>
        <tr>
          <th class="sticky-col">Ticker</th>
          <th data-col="name">Empresa</th>
          <th data-col="price">Preço</th>
          <th data-col="eps">EPS</th>
          <th data-col="bvps">VPA</th>
          <th data-col="pe">P/L</th>
          <th data-col="pb">P/VP</th>
          <th data-col="marketCap">Market Cap</th>
          <th data-col="sharesOutstanding">Ações</th>
          <th data-col="totalDebt">Dívida</th>
          <th data-col="cash">Caixa</th>
          <th data-col="ebitda">EBITDA</th>
          <th data-col="equity">Patrimônio</th>
          <th data-col="netIncome">Lucro</th>
          <th data-col="revenue">Receita</th>
          <th data-col="ev">EV</th>
          <th data-col="evEbitda">EV/EBITDA</th>
          <th data-col="netMargin">Marg. Líq.%</th>
          <th data-col="roe">ROE%</th>
          <th data-col="intrinsic">Valor Intrínseco</th>
          <th data-col="marginOfSafety">MoS</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="s: ${stocks}">
          <td class="sticky-col"><span class="ticker" th:text="${s.ticker}"></span></td>
          <td data-col="name" th:text="${s.name}"></td>
          <td data-col="price" data-money th:attr="data-val=${s.price}" th:text="${s.price}"></td>
          <td data-col="eps" th:text="${#numbers.formatDecimal(s.eps,1,2)}"></td>
          <td data-col="bvps" th:text="${#numbers.formatDecimal(s.bvps,1,2)}"></td>
          <td data-col="pe" th:text="${#numbers.formatDecimal(s.pe,1,2)}"></td>
          <td data-col="pb" th:text="${#numbers.formatDecimal(s.pb,1,2)}"></td>
          <td data-col="marketCap" data-money th:attr="data-val=${s.marketCap}" th:text="${s.marketCap}"></td>
          <td data-col="sharesOutstanding" th:text="${#numbers.formatDecimal(s.sharesOutstanding,1,2)}"></td>
          <td data-col="totalDebt" data-money th:attr="data-val=${s.totalDebt}" th:text="${s.totalDebt}"></td>
          <td data-col="cash" data-money th:attr="data-val=${s.cash}" th:text="${s.cash}"></td>
          <td data-col="ebitda" th:text="${#numbers.formatDecimal(s.ebitda,1,2)}"></td>
          <td data-col="equity" th:text="${#numbers.formatDecimal(s.equity,1,2)}"></td>
          <td data-col="netIncome" th:text="${#numbers.formatDecimal(s.netIncome,1,2)}"></td>
          <td data-col="revenue" th:text="${#numbers.formatDecimal(s.revenue,1,2)}"></td>
          <td data-col="ev" th:text="${#numbers.formatDecimal(s.ev,1,2)}"></td>
          <td data-col="evEbitda" th:text="${#numbers.formatDecimal(s.evEbitda,1,2)}"></td>
          <td data-col="netMargin" th:text="${#numbers.formatPercent(s.netMargin,1,2)}"></td>
          <td data-col="roe" th:text="${#numbers.formatPercent(s.roe,1,2)}"></td>
          <td data-col="intrinsic" data-money th:attr="data-val=${s.intrinsic}" th:text="${s.intrinsic}"></td>
          <td data-col="marginOfSafety">
            <span class="badge"
                  th:classappend="${s.marginOfSafety != null and s.marginOfSafety >= 0} ? ' badge-pos' : ' badge-neg'"
                  th:text="${s.marginOfSafety != null ? #numbers.formatPercent(s.marginOfSafety,1,2) : 'N/A'}"></span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <p class="hint">Dica: use o painel de colunas para focar só no que importa pra sua análise.</p>
  </section>
</main>

<footer class="container app-footer">
  <p>Feito com Spring Boot + Thymeleaf • Dados brapi.dev</p>
</footer>
<script>
(function(){
  const methodSel = document.getElementById('method');
  const peWrap = document.getElementById('peTargetWrap');
  const evWrap = document.getElementById('evTargetWrap');

  function syncMethodVisibility() {
    const m = methodSel ? methodSel.value : 'GRAHAM';
    if (peWrap) peWrap.style.display = (m === 'PE_TARGET') ? 'inline-flex' : 'none';
    if (evWrap) evWrap.style.display = (m === 'EV_EBITDA_TARGET') ? 'inline-flex' : 'none';
  }

  const colsField = document.getElementById('columnsField');
  const checks = document.querySelectorAll('.cols-grid input[type=checkbox]');
  const btnAll = document.getElementById('btnAllColumns');
  const btnDefault = document.getElementById('btnDefaultColumns');
  const DEFAULT_COLS = ['price','eps','bvps','intrinsic','marginOfSafety'];

  function isDefaultSelection(activeSet){
    if (!activeSet || activeSet.size !== DEFAULT_COLS.length) return false;
    return DEFAULT_COLS.every(c => activeSet.has(c));
  }
  function updatePresetButton(activeSet){
    if (!btnDefault) return;
    const on = isDefaultSelection(activeSet);
    btnDefault.classList.toggle('is-on', on);
    btnDefault.setAttribute('aria-pressed', on ? 'true' : 'false');
  }

  function applyColumnsVisibility(){
    const active = new Set(Array.from(checks).filter(c => c.checked).map(c => c.dataset.col));
    if (colsField) colsField.value = Array.from(active).join(',');

    document.querySelectorAll('[data-col]').forEach(el => {
      const show = active.has(el.getAttribute('data-col'));
      const isCell = el.tagName === 'TD' || el.tagName === 'TH';
      el.style.display = show ? (isCell ? 'table-cell' : '') : 'none';
    });
    formatMoneyCells();
    updatePresetButton(active);
  }

  const moneyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', notation: 'compact', maximumFractionDigits: 2 });
  function formatMoneyCells(){
    document.querySelectorAll('td[data-money]').forEach(td => {
      const raw = td.getAttribute('data-val') ?? td.textContent;
      const val = Number(raw);
      if (!isNaN(val)) {
        td.textContent = moneyFormatter.format(val);
      }
    });
  }

  if (btnAll) btnAll.addEventListener('click', () => {
    checks.forEach(ch => ch.checked = true);
    applyColumnsVisibility();
  });
  if (btnDefault) btnDefault.addEventListener('click', () => {
    const set = new Set(DEFAULT_COLS);
    checks.forEach(ch => ch.checked = set.has(ch.dataset.col));
    applyColumnsVisibility();
  });
  // Se houver preset vindo do backend (query ?columns=...)
  if (colsField && colsField.value) {
    const preset = colsField.value.split(',').map(s => s.trim()).filter(Boolean);
    checks.forEach(ch => ch.checked = preset.includes(ch.dataset.col));
  }

  // Aplica imediatamente ao carregar
  window.addEventListener('DOMContentLoaded', applyColumnsVisibility);
  window.addEventListener('DOMContentLoaded', syncMethodVisibility);
  window.addEventListener('DOMContentLoaded', formatMoneyCells);
  window.addEventListener('DOMContentLoaded', () => {
    const active = new Set(Array.from(checks).filter(c => c.checked).map(c => c.dataset.col));
    updatePresetButton(active);
  });

  // Reaplica ao marcar/desmarcar
  checks.forEach(ch => ch.addEventListener('change', applyColumnsVisibility));
  if (methodSel) methodSel.addEventListener('change', syncMethodVisibility);
})();
</script>
</body>
</html>